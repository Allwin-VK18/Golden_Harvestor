<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Golden Harvest: Farming Story</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --ui-bg: rgba(15, 20, 25, 0.95);
            --accent: #f39c12;
            --success: #2ecc71;
            --text: #ecf0f1;
            --danger: #e74c3c;
        }

        html {
            width: 100%;
            height: 100%;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #000;
            user-select: none;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
            width: 100vw;
            height: 100vh;
            position: fixed;
        }

        /* Overlays */
        .overlay {
            position: absolute;
            inset: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            background: radial-gradient(circle, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.8) 100%);
            backdrop-filter: blur(10px);
            transition: opacity 0.4s ease;
        }

        .menu-card {
            background: var(--ui-bg);
            padding: 30px;
            border-radius: 25px;
            text-align: center;
            color: white;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            max-height: 85vh;
            overflow-y: auto;
            box-sizing: border-box;
        }

        h1 { font-size: 28px; margin-bottom: 10px; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; }
        h2 { font-size: 18px; color: var(--accent); margin-top: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; text-align: left; }
        p { opacity: 0.8; margin-bottom: 25px; line-height: 1.5; font-size: 14px; }

        .grid-select {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .select-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .select-item:hover { background: rgba(255,255,255,0.1); transform: translateY(-3px); }
        .select-item:active { transform: scale(0.95); }
        .select-item.active { border-color: var(--accent); background: rgba(243, 156, 18, 0.2); }
        .icon { font-size: 32px; margin-bottom: 8px; display: block; }
        .item-name { font-weight: bold; display: block; margin-bottom: 3px; font-size: 14px; }
        .item-desc { font-size: 10px; opacity: 0.6; }

        .btn {
            background: var(--accent);
            color: black;
            border: none;
            padding: 12px 35px;
            font-size: 16px;
            font-weight: 800;
            border-radius: 50px;
            cursor: pointer;
            text-transform: uppercase;
            margin-top: 15px;
            transition: transform 0.2s;
        }
        .btn:hover:not(:disabled) { transform: scale(1.05); }
        .btn:disabled { background: #555; cursor: not-allowed; opacity: 0.5; }

        /* HUD */
        #hud {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            pointer-events: none;
            display: none;
            width: calc(100% - 40px);
            display: flex;
            justify-content: space-between;
        }

        .hud-left, .hud-right { display: flex; flex-direction: column; gap: 10px; }

        .hud-card {
            background: var(--ui-bg);
            padding: 12px 20px;
            border-radius: 15px;
            border-left: 5px solid var(--accent);
            color: white;
            backdrop-filter: blur(5px);
            pointer-events: auto;
            min-width: 120px;
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-fill { height: 100%; width: 0%; background: var(--success); transition: width 0.3s; }

        #settings-btn { display: none; }

        #growth-timer {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 18px;
            font-weight: 900;
            text-align: center;
            display: none;
            z-index: 50;
            background: rgba(0,0,0,0.6);
            padding: 10px 30px;
            border-radius: 40px;
            backdrop-filter: blur(5px);
            width: 80%;
            max-width: 300px;
        }

        /* Improved Mobile Controls */
        #mobile-controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            display: none;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
            z-index: 15;
            pointer-events: none;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: auto;
        }

        .ctrl-btn {
            width: 70px; height: 70px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 28px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            -webkit-user-select: none;
        }

        .ctrl-btn:active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0.9);
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        /* Mobile specific HUD adjustments */
        @media (max-width: 768px) {
            #hud {
                top: 10px;
                left: 10px;
                width: calc(100% - 20px);
                flex-direction: column;
                gap: 10px;
            }
            .hud-left, .hud-right {
                flex-direction: row;
                gap: 8px;
            }
            .hud-card {
                padding: 8px 12px;
                min-width: auto;
                flex: 1;
            }
            h1 { font-size: 22px; }
            h2 { font-size: 16px; }
            p { font-size: 13px; }
            #growth-timer { font-size: 14px; bottom: 150px; max-width: 90vw; }
            .menu-card {
                width: 95vw;
                max-width: 100%;
                padding: 20px;
                border-radius: 15px;
                max-height: 90vh;
            }
            .grid-select {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 10px;
            }
            .ctrl-btn {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            #mobile-controls {
                bottom: 20px;
                padding: 0 15px;
            }
        }
        
        @media (max-width: 480px) {
            h1 { font-size: 20px; }
            p { font-size: 12px; }
            #growth-timer { font-size: 12px; bottom: 130px; }
            .menu-card { padding: 15px; }
            .ctrl-btn {
                width: 55px;
                height: 55px;
                font-size: 22px;
            }
            .hud-card { padding: 6px 10px; font-size: 12px; }
        }
    </style>
</head>
<body>

    <!-- STAGE 1: CROP SELECTION -->
    <div id="crop-screen" class="overlay">
        <div class="menu-card">
            <h1>Select Your Crop</h1>
            <p>Every great harvest begins with a single seed.</p>
            <div class="grid-select">
                <div class="select-item" onclick="selectCrop('tomato', this)">
                    <span class="icon">üçÖ</span>
                    <span class="item-name">Tomatoes</span>
                    <span class="item-desc">Fast growing berries</span>
                </div>
                <div class="select-item" onclick="selectCrop('corn', this)">
                    <span class="icon">üåΩ</span>
                    <span class="item-name">Corn</span>
                    <span class="item-desc">Tall golden stalks</span>
                </div>
                <div class="select-item" onclick="selectCrop('wheat', this)">
                    <span class="icon">üåæ</span>
                    <span class="item-name">Wheat</span>
                    <span class="item-desc">The classic harvest</span>
                </div>
            </div>
            <button id="start-growth-btn" class="btn" disabled onclick="startGrowthSequence()">Plant Seeds</button>
        </div>
    </div>

    <!-- STAGE 2: HARVESTER SELECTION -->
    <div id="harvester-screen" class="overlay" style="display: none; opacity: 0;">
        <div class="menu-card">
            <h1>Choose Your Machine</h1>
            <p>Select a harvester from your fleet to bring in the bounty.</p>
            <div class="grid-select">
                <div class="select-item" onclick="selectHarvester('classic', this)">
                    <span class="icon">üöú</span>
                    <span class="item-name">Classic-G</span>
                    <span class="item-desc">Balanced Stats</span>
                </div>
                <div class="select-item" onclick="selectHarvester('sprinter', this)">
                    <span class="icon">üèéÔ∏è</span>
                    <span class="item-name">Red-Bolt</span>
                    <span class="item-desc">High Speed</span>
                </div>
                <div class="select-item" onclick="selectHarvester('titan', this)">
                    <span class="icon">üèóÔ∏è</span>
                    <span class="item-name">Titan-X</span>
                    <span class="item-desc">Double Capacity</span>
                </div>
                <div class="select-item" onclick="selectHarvester('gold', this)">
                    <span class="icon">‚ú®</span>
                    <span class="item-name">Gold-Pro</span>
                    <span class="item-desc">Triple Wide Header</span>
                </div>
            </div>
            <button id="start-harvest-btn" class="btn" disabled onclick="startHarvesting()">Begin Harvest</button>
        </div>
    </div>

    <!-- STAGE 3: COMPLETION SCREEN -->
    <div id="complete-screen" class="overlay" style="display: none; opacity: 0;">
        <div class="menu-card">
            <h1 style="color: var(--success);">Harvest Complete!</h1>
            <p>You've successfully cleared the field.</p>
            <div style="font-size: 24px; margin-bottom: 20px; font-weight: 900;" id="complete-stats">
                Earnings: $0
            </div>
            <button class="btn" onclick="resetToMenu()">New Season</button>
        </div>
    </div>

    <!-- SETTINGS (Hiddem) -->
    <div id="settings-screen" style="display: none;"></div>

    <!-- HUD -->
    <div id="hud">
        <div class="hud-left">
            <div class="hud-card">
                <div style="font-size: 9px; opacity: 0.6; text-transform: uppercase; letter-spacing: 1px;">Balance</div>
                <div id="money-val" style="font-size: 18px; font-weight: 900;">$0</div>
            </div>
        </div>
        <div class="hud-right">
            <div class="hud-card" style="border-left-color: var(--success);">
                <div id="crop-label" style="font-size: 9px; opacity: 0.6; text-transform: uppercase; letter-spacing: 1px;">Field Progress</div>
                <div id="harvest-percent" style="font-size: 18px; font-weight: 900;">0%</div>
                <div class="progress-container">
                    <div id="harvest-fill" class="progress-fill"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="growth-timer">SEASON PROGRESS: 0%</div>

    <div id="mobile-controls">
        <div class="control-group">
            <div class="ctrl-btn" oncontextmenu="return false;" ontouchstart="handleTouchInput('KeyW', true, event)" ontouchend="handleTouchInput('KeyW', false, event)">‚Üë</div>
            <div class="ctrl-btn" oncontextmenu="return false;" ontouchstart="handleTouchInput('KeyS', true, event)" ontouchend="handleTouchInput('KeyS', false, event)">‚Üì</div>
        </div>
        <div class="control-group" style="flex-direction: row; align-items: flex-end;">
            <div class="ctrl-btn" oncontextmenu="return false;" ontouchstart="handleTouchInput('KeyA', true, event)" ontouchend="handleTouchInput('KeyA', false, event)">‚Üê</div>
            <div class="ctrl-btn" oncontextmenu="return false;" ontouchstart="handleTouchInput('KeyD', true, event)" ontouchend="handleTouchInput('KeyD', false, event)">‚Üí</div>
        </div>
    </div>

    <script>
        // --- Globals ---
        let scene, camera, renderer, clock, sun;
        let player, harvesterBlade, dischargePipe, navArrow;
        let crops = [], particles = [], rain = [];
        let keys = {};
        
        let gameState = {
            stage: 'menu', 
            selectedCrop: null,
            selectedHarvester: null,
            money: 0,
            grain: 0,
            capacity: 100,
            maxSpeed: 0.25,
            currentVelocity: 0,
            acceleration: 0.006,
            friction: 0.965,
            bladeWidth: 4.0,
            unloading: false,
            harvestCount: 0,
            totalCrops: 0,
            settings: {
                volume: 0.5,
                quality: 'high',
                sensitivity: 1.0,
                difficulty: 'standard'
            }
        };

        const CONFIG = {
            worldSize: 100,
            tileSize: 2.5,
            siloPos: { x: -35, z: -35 }
        };

        const bgMusic = new Audio('https://cdn.pixabay.com/audio/2022/10/26/audio_40b2a26514.mp3'); 
        bgMusic.loop = true;

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.Fog(0x87ceeb, 40, 120);

            const width = window.innerWidth;
            const height = window.innerHeight;
            
            camera = new THREE.PerspectiveCamera(55, width / height, 0.1, 1000);
            camera.position.set(40, 40, 40);
            camera.lookAt(0,0,0);

            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance", alpha: false });
            renderer.setSize(width, height);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.domElement.style.width = '100%';
            renderer.domElement.style.height = '100%';
            renderer.domElement.style.display = 'block';
            document.body.appendChild(renderer.domElement);

            clock = new THREE.Clock();

            setupLights();
            createGround();
            createSilo();
            createNavArrow();

            window.addEventListener('keydown', e => keys[e.code] = true);
            window.addEventListener('keyup', e => keys[e.code] = false);
            window.addEventListener('resize', onWindowResize);

            // Check if mobile and show controls
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 'ontouchstart' in window;
            if (isMobile) {
                document.getElementById('mobile-controls').style.display = 'flex';
            }

            applySettings();
            animate();
        }

        function handleTouchInput(key, state, event) {
            if(event) {
                event.preventDefault();
                event.stopPropagation();
            }
            keys[key] = state;
        }

        function applySettings() {
            const s = gameState.settings;
            bgMusic.volume = s.volume;
            renderer.setPixelRatio(window.devicePixelRatio > 2 ? 2 : window.devicePixelRatio);
        }

        function setupLights() {
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            sun = new THREE.DirectionalLight(0xfff5e6, 1.0);
            sun.position.set(50, 60, 20);
            sun.castShadow = true;
            sun.shadow.camera.left = -60; sun.shadow.camera.right = 60;
            sun.shadow.camera.top = 60; sun.shadow.camera.bottom = -60;
            sun.shadow.mapSize.width = 1024;
            sun.shadow.mapSize.height = 1024;
            scene.add(sun);
        }

        function createGround() {
            const ground = new THREE.Mesh(
                new THREE.PlaneGeometry(300, 300),
                new THREE.MeshStandardMaterial({ color: 0x3e2723 })
            );
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            const grass = new THREE.Mesh(
                new THREE.PlaneGeometry(CONFIG.worldSize + 20, CONFIG.worldSize + 20),
                new THREE.MeshStandardMaterial({ color: 0x2e7d32 })
            );
            grass.rotation.x = -Math.PI / 2;
            grass.position.y = 0.02;
            scene.add(grass);
        }

        function createSilo() {
            const silo = new THREE.Group();
            const body = new THREE.Mesh(new THREE.CylinderGeometry(5,5,18,16), new THREE.MeshStandardMaterial({color:0xb71c1c}));
            body.position.y = 9; body.castShadow = true; silo.add(body);
            const top = new THREE.Mesh(new THREE.SphereGeometry(5.1,16,8,0,Math.PI*2,0,Math.PI/2), new THREE.MeshStandardMaterial({color:0xf5f5f5}));
            top.position.y = 18; silo.add(top);
            silo.position.set(CONFIG.siloPos.x, 0, CONFIG.siloPos.z);
            scene.add(silo);
        }

        function selectCrop(type, el) {
            gameState.selectedCrop = type;
            document.querySelectorAll('#crop-screen .select-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('start-growth-btn').disabled = false;
        }

        function startGrowthSequence() {
            if (bgMusic.paused) {
                bgMusic.play().catch(e => console.log("Blocked"));
            }

            document.getElementById('crop-screen').style.opacity = '0';
            setTimeout(() => document.getElementById('crop-screen').style.display = 'none', 500);
            
            gameState.stage = 'growing';
            createCrops(gameState.selectedCrop);
            
            document.getElementById('growth-timer').style.display = 'block';
            
            let progress = 0;
            const growthInterval = setInterval(() => {
                if (gameState.stage !== 'growing') {
                    clearInterval(growthInterval);
                    return;
                }
                progress += 1;
                document.getElementById('growth-timer').innerText = `SEASON PROGRESS: ${progress}%`;
                
                crops.forEach(c => {
                    if(c.scale.y < 1.0) {
                        c.scale.y += 0.015;
                        c.position.y = (c.scale.y * (c.userData.maxH || 1.5)) / 2;
                    }
                });

                if(progress > 20 && progress < 80) {
                    spawnRain();
                    sun.intensity = 0.4;
                    scene.background.lerp(new THREE.Color(0x445566), 0.05);
                } else {
                    sun.intensity = 1.2;
                    scene.background.lerp(new THREE.Color(0x87ceeb), 0.05);
                }

                if(progress >= 100) {
                    clearInterval(growthInterval);
                    document.getElementById('growth-timer').style.display = 'none';
                    showHarvesterMenu();
                }
            }, 100); 
        }

        function showHarvesterMenu() {
            const screen = document.getElementById('harvester-screen');
            screen.style.display = 'flex';
            setTimeout(() => screen.style.opacity = '1', 50);
            gameState.stage = 'harvester_select';
        }

        function selectHarvester(type, el) {
            gameState.selectedHarvester = type;
            document.querySelectorAll('#harvester-screen .select-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('start-harvest-btn').disabled = false;
        }

        function startHarvesting() {
            document.getElementById('harvester-screen').style.opacity = '0';
            setTimeout(() => document.getElementById('harvester-screen').style.display = 'none', 500);

            const diffMult = gameState.settings.difficulty === 'easy' ? 2.0 : 1.0;
            gameState.maxSpeed = 0.25;
            gameState.acceleration = 0.006;
            gameState.bladeWidth = 4.0;
            gameState.capacity = 100 * diffMult;

            const h = gameState.selectedHarvester;
            if(h === 'sprinter') { gameState.maxSpeed = 0.45; gameState.acceleration = 0.01; }
            if(h === 'titan') { gameState.capacity *= 3; }
            if(h === 'gold') { gameState.bladeWidth = 8.0; }
            
            createHarvester(h);
            gameState.stage = 'playing';
            document.getElementById('hud').style.display = 'flex';
            
            // Show mobile controls if on touch device
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 'ontouchstart' in window;
            if (isMobile) {
                document.getElementById('mobile-controls').style.display = 'flex';
            }
        }

        function showCompleteScreen() {
            gameState.stage = 'complete';
            const screen = document.getElementById('complete-screen');
            document.getElementById('complete-stats').innerText = `Season Earnings: $${Math.floor(gameState.money)}`;
            screen.style.display = 'flex';
            setTimeout(() => screen.style.opacity = '1', 50);
            
            document.getElementById('hud').style.display = 'none';
            document.getElementById('mobile-controls').style.display = 'none';
        }

        function resetToMenu() {
            if(player) scene.remove(player);
            crops.forEach(c => scene.remove(c));
            crops = [];
            
            gameState.stage = 'menu';
            gameState.harvestCount = 0;
            gameState.totalCrops = 0;
            gameState.grain = 0;
            gameState.currentVelocity = 0;
            
            updateHUD();
            document.getElementById('complete-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('complete-screen').style.display = 'none';
                const cropScreen = document.getElementById('crop-screen');
                cropScreen.style.display = 'flex';
                setTimeout(() => cropScreen.style.opacity = '1', 50);
            }, 500);

            document.querySelectorAll('.select-item').forEach(i => i.classList.remove('active'));
            document.getElementById('start-growth-btn').disabled = true;
            document.getElementById('start-harvest-btn').disabled = true;
            
            camera.position.set(40, 40, 40);
            camera.lookAt(0,0,0);
        }

        function createCrops(type) {
            crops.forEach(c => scene.remove(c));
            crops = [];
            const spacing = CONFIG.tileSize;
            const bounds = 22;

            for(let x = -bounds; x < bounds; x += spacing) {
                for(let z = -bounds; z < bounds; z += spacing) {
                    const group = new THREE.Group();
                    if(type === 'tomato') {
                        const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 1.2), new THREE.MeshStandardMaterial({color:0x1b5e20}));
                        group.add(stem);
                        for(let i=0; i<3; i++) {
                            const t = new THREE.Mesh(new THREE.SphereGeometry(0.25, 8, 8), new THREE.MeshStandardMaterial({color:0xe53935}));
                            t.position.set(Math.random()-0.5, 0.3+Math.random()*0.5, Math.random()-0.5);
                            group.add(t);
                        }
                    } else if(type === 'corn') {
                        const stalk = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.1, 2.2), new THREE.MeshStandardMaterial({color:0x7cb342}));
                        group.add(stalk);
                        const ear = new THREE.Mesh(new THREE.SphereGeometry(0.15, 8, 8), new THREE.MeshStandardMaterial({color:0xffd600}));
                        ear.scale.set(1, 2.5, 1);
                        ear.position.y = 1; 
                        group.add(ear);
                    } else {
                        const wheat = new THREE.Mesh(new THREE.CylinderGeometry(0.02, 0.08, 1.5), new THREE.MeshStandardMaterial({color:0xffca28}));
                        group.add(wheat);
                    }

                    group.position.set(x + Math.random(), 0, z + Math.random());
                    group.scale.y = 0.01; 
                    group.userData.active = true;
                    group.userData.maxH = type === 'corn' ? 2.2 : 1.5;
                    scene.add(group);
                    crops.push(group);
                }
            }
            gameState.totalCrops = crops.length;
        }

        function createHarvester(style) {
            player = new THREE.Group();
            let bodyColor = 0x2e7d32;
            if(style === 'sprinter') bodyColor = 0xc62828;
            if(style === 'titan') bodyColor = 0x1565c0;
            if(style === 'gold') bodyColor = 0xffd700;

            const body = new THREE.Mesh(new THREE.BoxGeometry(2.6, 1.4, 4.8), new THREE.MeshStandardMaterial({color: bodyColor}));
            body.position.y = 1.3; body.castShadow = true; player.add(body);
            
            const cab = new THREE.Mesh(new THREE.BoxGeometry(2.2, 1.6, 1.6), new THREE.MeshStandardMaterial({color: 0xb3e5fc, transparent:true, opacity:0.6}));
            cab.position.set(0, 2.5, 1.4); player.add(cab);

            const wheelMat = new THREE.MeshStandardMaterial({color: 0x111111});
            const fw = new THREE.CylinderGeometry(0.9, 0.9, 0.7, 12);
            [[1.5,0.9,1.6], [-1.5,0.9,1.6], [1.2,0.6,-1.9], [-1.2,0.6,-1.9]].forEach(p => {
                const w = new THREE.Mesh(fw, wheelMat); w.rotation.z = Math.PI/2; w.position.set(...p); player.add(w);
            });

            harvesterBlade = new THREE.Group();
            const frame = new THREE.Mesh(new THREE.BoxGeometry(gameState.bladeWidth, 0.7, 1.4), new THREE.MeshStandardMaterial({color:0x333333}));
            harvesterBlade.add(frame);
            const reel = new THREE.Mesh(new THREE.CylinderGeometry(0.6,0.6,gameState.bladeWidth-0.4,12), new THREE.MeshStandardMaterial({color:0xffd54f, wireframe:true}));
            reel.rotation.z = Math.PI/2; reel.name="reel"; harvesterBlade.add(reel);
            harvesterBlade.position.set(0, 0.6, 3.1); player.add(harvesterBlade);

            dischargePipe = new THREE.Mesh(new THREE.CylinderGeometry(0.18, 0.18, 4.5), new THREE.MeshStandardMaterial({color:0xcccccc}));
            dischargePipe.rotation.x = Math.PI/2; dischargePipe.position.set(1.4, 2.4, -1); player.add(dischargePipe);

            scene.add(player);
        }

        function createNavArrow() {
            navArrow = new THREE.Mesh(new THREE.ConeGeometry(0.8, 2.5, 4), new THREE.MeshBasicMaterial({color:0xff0000}));
            navArrow.visible = false; scene.add(navArrow);
        }

        function spawnRain() {
            const drop = new THREE.Mesh(new THREE.BoxGeometry(0.05, 0.4, 0.05), new THREE.MeshBasicMaterial({color:0x00aaff, transparent:true, opacity:0.5}));
            drop.position.set((Math.random()-0.5)*100, 40, (Math.random()-0.5)*100);
            scene.add(drop); rain.push(drop);
        }

        function updateGame(dt) {
            if(gameState.stage !== 'playing') return;

            if (keys['ArrowUp'] || keys['KeyW']) gameState.currentVelocity += gameState.acceleration;
            else if (keys['ArrowDown'] || keys['KeyS']) gameState.currentVelocity -= gameState.acceleration;
            else gameState.currentVelocity *= gameState.friction;

            gameState.currentVelocity = Math.max(-gameState.maxSpeed/2, Math.min(gameState.maxSpeed, gameState.currentVelocity));

            const sPower = 0.15 * Math.abs(gameState.currentVelocity / gameState.maxSpeed) * gameState.settings.sensitivity;
            const sDir = gameState.currentVelocity >= 0 ? 1 : -1;
            if (keys['ArrowLeft'] || keys['KeyA']) player.rotation.y += sPower * sDir;
            if (keys['ArrowRight'] || keys['KeyD']) player.rotation.y -= sPower * sDir;

            player.translateZ(gameState.currentVelocity);
            if(Math.abs(gameState.currentVelocity) > 0.01) {
                const reel = harvesterBlade.getObjectByName("reel");
                if(reel) reel.rotation.x += 0.2;
            }

            const cOffset = new THREE.Vector3(0, 20, -25).applyQuaternion(player.quaternion);
            camera.position.lerp(player.position.clone().add(cOffset), 0.1);
            camera.lookAt(player.position.x, 2, player.position.z);

            const bPos = new THREE.Vector3(); harvesterBlade.getWorldPosition(bPos);
            crops.forEach(c => {
                if(c.userData.active && c.position.distanceTo(bPos) < gameState.bladeWidth/1.8) {
                    if (gameState.grain < gameState.capacity) {
                        c.userData.active = false;
                        c.scale.y = 0.1;
                        gameState.grain += 5;
                        gameState.harvestCount++;
                        updateHUD();
                    }
                }
            });

            if (gameState.harvestCount === gameState.totalCrops && gameState.totalCrops > 0) {
                showCompleteScreen();
            }

            if(player.position.distanceTo(new THREE.Vector3(CONFIG.siloPos.x, 0, CONFIG.siloPos.z)) < 12) {
                if(gameState.grain > 0) {
                    const bonus = gameState.settings.difficulty === 'easy' ? 1.5 : 1.0;
                    gameState.money += gameState.grain * bonus;
                    gameState.grain = 0;
                    updateHUD();
                }
            }

            if(gameState.grain >= gameState.capacity) {
                navArrow.visible = true;
                navArrow.position.set(player.position.x, 10, player.position.z);
                navArrow.lookAt(CONFIG.siloPos.x, 10, CONFIG.siloPos.z);
                navArrow.rotateX(Math.PI/2);
            } else { navArrow.visible = false; }
        }

        function updateHUD() {
            document.getElementById('money-val').innerText = `$${Math.floor(gameState.money)}`;
            const pct = gameState.totalCrops > 0 ? Math.floor((gameState.harvestCount / gameState.totalCrops) * 100) : 0;
            document.getElementById('harvest-percent').innerText = `${pct}%`;
            document.getElementById('harvest-fill').style.width = `${pct}%`;
        }

        function onWindowResize() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
            
            // Ensure canvas fills the screen
            renderer.domElement.style.width = '100%';
            renderer.domElement.style.height = '100%';
        }

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            if(gameState.stage === 'growing' || gameState.stage === 'playing') {
                updateGame(dt);
                for(let i=rain.length-1; i>=0; i--) {
                    rain[i].position.y -= 1;
                    if(rain[i].position.y < 0) { scene.remove(rain[i]); rain.splice(i, 1); }
                }
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('load', init);
        window.addEventListener('DOMContentLoaded', init);
        
        // Fallback for load event
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        Math.lerp = (a, b, t) => a + (b - a) * t;
    </script>
</body>
</html>